# GDEY029T94 局部刷新测试指南

## 测试目的
验证GDEY029T94电子墨水屏的局部刷新功能是否正常工作。

## 测试环境
- 硬件：ESP8266 NodeMCU + GDEY029T94 2.9寸黑白电子墨水屏
- 驱动：GxEPD2_290_GDEY029T94（支持快速局部刷新）
- 分辨率：128x296像素

## 优化内容
1. **修正显示器类型**：从GxEPD2_3C改为GxEPD2_BW（黑白显示器）
2. **8像素边界对齐**：确保局部刷新窗口符合GDEY029T94的硬件要求
3. **缓冲区初始化**：首次局部刷新前初始化屏幕缓冲区
4. **精确坐标计算**：确保分钟区域的准确定位和刷新

## 测试步骤

### 1. 上传代码
```bash
pio run --target upload
```

### 2. 观察串口输出
```bash
pio device monitor
```

### 3. 验证功能

#### 3.1 全屏刷新测试
- 设备启动时应显示完整的时间界面
- 包含：天气信息、时间、日期
- 屏幕应清晰显示，无残影

#### 3.2 局部刷新测试
- 等待分钟数变化（每分钟触发一次）
- 观察串口输出：
  ```
  Performing minute refresh
  Starting partial refresh...
  First partial refresh - initializing screen buffer
  Partial window: X=xx, Y=xx, W=xx, H=xx
  Minute text position: X=xx, Y=xx
  Partial refresh completed.
  ```

#### 3.3 刷新效果验证
- **正常情况**：只有分钟数字区域刷新，其他区域保持不变
- **刷新速度**：局部刷新应比全屏刷新快（约1-2秒 vs 5-10秒）
- **显示质量**：分钟数字应清晰，无重影或残留

### 4. 强制全屏刷新测试
- 等待30分钟或重启设备
- 观察串口输出：
  ```
  Performing forced full refresh (30min cycle)
  ```
- 整个屏幕应完全刷新

## 预期结果

### 成功指标
1. ✅ 分钟变化时只刷新分钟数字区域
2. ✅ 局部刷新速度明显快于全屏刷新
3. ✅ 分钟数字显示清晰，无残影
4. ✅ 其他区域（天气、小时、日期）保持不变
5. ✅ 串口输出显示正确的窗口坐标

### 故障排除

#### 问题1：局部刷新不生效（整屏刷新）
- **可能原因**：窗口坐标计算错误
- **解决方案**：检查串口输出的窗口坐标是否合理

#### 问题2：分钟数字显示不清晰
- **可能原因**：窗口边界未对齐到8像素
- **解决方案**：确认windowX和windowW都是8的倍数

#### 问题3：刷新速度没有提升
- **可能原因**：未使用快速局部刷新模式
- **解决方案**：确认GDEY029T94驱动的hasFastPartialUpdate=true

#### 问题4：首次局部刷新异常
- **可能原因**：缓冲区未初始化
- **解决方案**：确认isFirstPartialRefresh逻辑正确执行

## 技术细节

### 局部刷新窗口计算
```cpp
// 确保8像素边界对齐
int windowX = (minuteX / 8) * 8;
int windowW = ((minuteTbw + 15) / 8) * 8;
```

### GDEY029T94特性
- 支持快速局部刷新（hasFastPartialUpdate = true）
- 要求窗口边界对齐到8像素边界
- 使用SSD1680控制器
- 分辨率：128x296像素

### 刷新时序
- 全屏刷新：每30分钟强制执行
- 局部刷新：每分钟执行（分钟数变化时）
- 首次局部刷新：包含缓冲区初始化

## 注意事项
1. 确保硬件连接正确
2. 使用正确的GxEPD2库版本
3. 电子墨水屏需要稳定的3.3V供电
4. 避免频繁刷新以延长屏幕寿命